<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="helpMapper">
	
	<!-- Partnership -->
	<resultMap type="Partnership" id="jt-help-partnership-map">
		<result column="pn" property="pn"/>
		<result column="name" property="name"/>
		<result column="email" property="email"/>
		<result column="phone_number" property="phoneNumber"/>
		<result column="category_pn" property="categoryPn"/>
		<result column="content" property="content"/>
		<result column="process" property="process"/>
		<result column="deposit" property="deposit"/>
		<result column="input_date" property="inputDate"/>
		<result column="update_date" property="updateDate"/>
		<result column="note" property="note"/>
		<result column="seller_pn" property="jtownUser.pn"/>
		<result column="shop_url" property="jtownUser.shopUrl"/>
		<result column="id" property="jtownUser.username"/>
		<result column="enable" property="jtownUser.enabled"/>
		<result column="salt" property="jtownUser.salt"/>
		<result column="seller_name" property="jtownUser.name"/>
		<result column="shop_pn" property="jtownUser.shopPn"/>
		<result column="contract_end_date" property="jtownUser.contractEndDate"/>
		<result column="begin_start_date" property="jtownUser.beginStartDate"/>
		<result column="admin_pn" property="adminUser.pn"/>
		<result column="admin_name" property="adminUser.name"/>
	</resultMap>
	
	<select id="selectPartnership" parameterType="Integer" resultMap="jt-help-partnership-map">
		SELECT
			p.pn, p.name, p.email, p.phone_number,
			p.category_pn, p.content, p.process, p.deposit, p.input_date, p.update_date, p.note
			<if test="pn != null">
			,u.pn AS seller_pn, u.shop_pn, u.shop_url, u.id, u.enable, u.salt, u.name AS seller_name,
			u.begin_start_date, u.contract_end_date,
			ua.pn AS admin_pn, ua.name AS admin_name	
			</if>
		FROM
			partnership p
			<if test="pn != null">
			LEFT OUTER JOIN ( 
				SELECT 
					us.pn, us.shop_pn, us.shop_url, u.id, u.enable, u.salt, u.name, 
					uscie.contract_end_date, uscib.begin_start_date
				FROM 
					user_seller us
					LEFT OUTER JOIN(
						SELECT
							seller_pn, end_date AS contract_end_date
						FROM
							user_seller_contract_info
						WHERE
							DATE_FORMAT(SYSDATE(), '%Y-%m-%d') BETWEEN start_date AND end_date
					) uscie
					ON us.pn = uscie.seller_pn
					LEFT OUTER JOIN	(
						<![CDATA[
						SELECT
							seller_pn, MIN(start_date) AS begin_start_date
						FROM
							user_seller_contract_info
						WHERE
							DATE_FORMAT(SYSDATE(), '%Y-%m-%d') < start_date
						GROUP BY
							seller_pn
						]]>
					) uscib
					ON us.pn = uscib.seller_pn		
					, users u 
				WHERE 
					us.pn = u.pn 
			) u
			ON u.pn = p.seller_pn
			LEFT OUTER JOIN ( SELECT u.pn, u.name FROM user_admin ua, users u WHERE ua.pn = u.pn AND u.enable = TRUE ) ua
			ON ua.pn = p.admin_pn
			</if>
		WHERE
		<if test="pn != null">
			p.pn = #{pn}		
		</if>
		<if test="email != null">
			p.email = #{email}
		AND
			p.process = 1
		</if>
		<if test="phoneNumber != null">
			p.phone_number = #{phoneNumber}
		AND
			p.process = 1
		</if>
	</select>
	
	<select id="selectPartnershipCategory" parameterType="Integer" resultType="Integer">
		SELECT
			category_pn AS categoryPn
		FROM
			partnership
		WHERE
			pn = #{pn}
	</select>
	
	<insert id="insertPartnership" parameterType="Partnership">
		INSERT INTO
			partnership
			(	name,	email,	phone_number,	category_pn,	content,	process, deposit, input_date, update_date	)
		VAlUES	
			(	#{name},	#{email},	#{phoneNumber},	#{categoryPn},	#{content}, #{process}, #{deposit}, SYSDATE(), SYSDATE()	)
		<selectKey keyProperty="pn" resultType="java.lang.Integer">
			SELECT LAST_INSERT_ID()
		</selectKey>
	</insert>
	
	<!-- FAQ -->
	
	<resultMap type="Question" id="jt-help-question-map">
		<result property="pn" column="pn"/>
		<result property="questionSection.questionCategory.name" column="category_name"/>
		<result property="questionSection.name" column="section_name"/>
		<result property="name" column="name"/>
		<result property="email" column="email"/>		
		<result property="browser" column="browser"/>
		<result property="title" column="title"/>
		<result property="content" column="content"/>
		<result property="inputDate" column="input_date"/>
		<result property="shopPn" column="shop_pn"/>
	</resultMap>
	
	<select id="selectQuestion" parameterType="Integer" resultMap="jt-help-question-map">
		SELECT
			q.pn, qc.name AS category_name, qs.name AS section_name,  
			q.name, q.email, q.browser, q.title, q.content, q.input_date, q.shop_pn
		FROM
			question q,
			question_category qc,
			question_section qs
		WHERE
			qc.pn = qs.category_pn	
		AND
			q.section = qs.pn
		AND
			q.pn = #{questionPn}
	</select>
	
	<resultMap type="QuestionSection" id="jt-question-section-map">
		<result property="pn" column="pn"/>
		<result property="name" column="name"/>
	</resultMap>
	
	<select id="selectQuestionSections" parameterType="Integer" resultMap="jt-question-section-map">
		SELECT
			pn, name
		FROM
			question_section
		WHERE
			category_pn = #{categoryPn}
	</select>	
	
	<select id="selectQuestionCategories" resultType="QuestionCategory">
		SELECT
			pn, name
		FROM
			question_category
	</select>
	
	<insert id="insertQuestion" parameterType="Question">
		INSERT INTO
			question
			( section, name, email, browser, title, content, input_date, shop_pn	)
		VALUES
			( #{questionSection.pn}, #{name}, #{email}, #{browser}, #{title}, #{content}, SYSDATE(), #{shopPn} )
	</insert>
	
</mapper>