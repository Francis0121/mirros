<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="loginMapper">

	<select id="checkExistEmail" parameterType="String" resultType="Integer">
		SELECT count(*) FROM users WHERE id = #{id}
	</select>
	
	<select id="findGroupId" parameterType="String" resultType="Integer">
		SELECT id FROM groups WHERE group_name = #{group}
	</select>
	
	<resultMap type="com.bg.jtown.security.JtownUser" id="jtown-customer-map">
		<result column="join_date" property="joinDate"/>
	</resultMap>
	
	<select id="selectCustomer" parameterType="Integer" resultMap="jtown-customer-map">
		SELECT
			join_date
		FROM
			user_customer
		WHERE
			pn = #{pn}
	</select>
	
	<insert id="insertUsers" parameterType="JtownUser">
		INSERT INTO
			users
			( id, password, enable, salt, name )
		VALUES
			( #{username}, #{password}, #{enabled}, #{salt}, #{name} )
		<selectKey keyProperty="pn" resultType="Integer">
			SELECT LAST_INSERT_ID()
		</selectKey>
	</insert>
	
	<insert id="insertUserCustomer" parameterType="JtownUser">
		INSERT INTO
			user_customer
			( pn, join_date )
		VALUES
			( #{pn}, SYSDATE() )			
	</insert>
	
	<insert id="insertUserSeller" parameterType="JtownUser">
		INSERT
			user_seller
			( pn, shop_url )		
		VALUES
			( #{pn}, #{shopUrl} )
	</insert>	
		
	<insert id="addUserToGroup" parameterType="Map">
		INSERT INTO
			group_members
			( group_id, user_pn )
		VALUES
			( #{groupId}, #{userPn} )
	</insert>
	
	<update id="changePassword" parameterType="JtownUser">
		UPDATE
			users
		SET
			password = #{newPassword},
			salt = #{salt}
		WHERE
			id = #{username}
	</update>
	
	<update id="updateUserCustomer" parameterType="com.bg.jtown.security.JtownUser">
		UPDATE 
			users
		SET	
			name = #{name}
		WHERE 
			pn = #{pn}
	</update>
		
	<!-- Use Only TestCase -->
	<delete id="deleteUserAll">
		DELETE FROM users
	</delete>
	
	<select id="selectUsersCount" resultType="Integer">
		SELECT COUNT(*) FROM users
	</select>
	
</mapper>