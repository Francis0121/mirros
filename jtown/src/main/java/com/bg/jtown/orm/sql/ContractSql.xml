<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="contractMapper">
	
	<sql id="paginationBefore">
		SELECT 
			t.*
		FROM 
		( 
			SELECT  
				z.*, @RNUM := @RNUM + 1 AS rnum
			FROM
				(
	</sql>
	
	<sql id="paginationAfter">
		<![CDATA[
				) z,  
				( SELECT @RNUM := 0 ) R
			WHERE @RNUM + 1 <=  #{pagination.itemSeqEnd}
		) t
		WHERE t.rnum >= #{pagination.itemSeqBegin}
		]]>
	</sql>
	
	<resultMap type="com.bg.jtown.business.Contract" id="jt-contract-map">
		<result column="pn" property="pn"/>
		<result column="seller_pn" property="sellerPn"/>
		<result column="start_date" property="startDate"/>
		<result column="end_date" property="endDate"/>
		<result column="input_date" property="inputDate"/>
		<result column="contract_count" property="contractCount"/>
		<result column="contract_end_date" property="contractEndDate"/>
	</resultMap>
	
	<select id="selectContractList" parameterType="com.bg.jtown.business.search.ContractFilter" resultMap="jt-contract-map">
		<include refid="paginationBefore"/>
		SELECT
			pn, seller_pn, start_date, end_date, input_date
		FROM
			user_seller_contract_info
		WHERE
			seller_pn = #{sellerPn}
		ORDER BY
			input_date DESC
		<include refid="paginationAfter"/>	
	</select>
	
	<select id="selectContract" parameterType="com.bg.jtown.business.Contract" resultMap="jt-contract-map">
		SELECT
			pn, seller_pn, start_date, end_date, input_date
		FROM
			user_seller_contract_info
		WHERE
			pn = #{pn}
	</select>
	
	<select id="selectContractCount" parameterType="com.bg.jtown.business.search.ContractFilter" resultType="java.lang.Integer">
		SELECT
			COUNT(pn)
		FROM
			user_seller_contract_info
		WHERE
			seller_pn = #{sellerPn}
	</select>
	
	<select id="selctContractPeroid" parameterType="com.bg.jtown.business.Contract" resultMap="jt-contract-map">
		SELECT
			usci.seller_pn, COUNT(usci.seller_pn) AS contract_count, now.contract_end_date 
		FROM
			user_seller_contract_info usci
			LEFT OUTER JOIN(
				SELECT
					seller_pn, end_date AS contract_end_date
				FROM
					user_seller_contract_info
				WHERE
					SYSDATE() BETWEEN start_date AND end_date
			) now
			ON usci.seller_pn = now.seller_pn
		WHERE
			usci.seller_pn = #{sellerPn}
		GROUP BY
			usci.seller_pn
	</select>
	
	<insert id="insertContract" parameterType="com.bg.jtown.business.Contract">
		INSERT INTO
			user_seller_contract_info
			( seller_pn, start_date, end_date, input_date )
		VALUES
			( #{sellerPn}, #{startDate}, #{endDate}, SYSDATE() )
	</insert>	
	
	<delete id="deleteContract" parameterType="com.bg.jtown.business.Contract">
		DELETE FROM
			user_seller_contract_info
		WHERE
			pn = #{pn}
	</delete>
	
</mapper>