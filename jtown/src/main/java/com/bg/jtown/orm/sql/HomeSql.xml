<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="homeMapper">

	<sql id="paginationBefore">
		SELECT 
			t.*
		FROM 
		( 
			SELECT  
				z.*, @RNUM := @RNUM + 1 AS rnum
			FROM
				(
	</sql>
	
	<sql id="paginationAfter">
		<![CDATA[
				) z,  
				( SELECT @RNUM := 0 ) R
			WHERE @RNUM + 1 <=  #{pagination.itemSeqEnd}#
		) t
		WHERE t.rnum >= #{pagination.itemSeqBegin}#
		]]>
	</sql>

	<resultMap type="com.bg.jtown.security.JtownUser" id="jtown-seller-map">
		<result column="pn" property="pn"/>
		<result column="shop_name" property="shopName"/>
		<result column="shop_url" property="shopUrl"/>
		<result column="notice" property="notice"/>
		<result column="love_count" property="loveCount"/>
		<result column="view_count" property="viewCount"/>
	</resultMap>

	<select id="selectFromInterestCategoryCount" parameterType="com.bg.jtown.business.search.HomeFilter" resultType="java.lang.Integer">
		SELECT
			COUNT(*)
		FROM	(
				SELECT
					us.pn
				FROM
					user_seller us,
					user_seller_interest usi,
					interest_section ise,
					interest_category ic
				WHERE
					us.pn = usi.seller_pn
				AND
					usi.section_pn = ise.pn
				AND
					ise.category_pn = ic.pn
				AND
					ise.category_pn = #{categoryPn}
				GROUP BY 
					us.pn
			) t
	</select>

	<select id="selectFromInterestCategory" parameterType="com.bg.jtown.business.search.HomeFilter" resultMap="jtown-seller-map">
		<include refid="paginationBefore"/>
		SELECT
			us.pn , us.shop_name, us.shop_url, us.notice, 
			us.love_count, us.view_count
		FROM
			user_seller us,
			user_seller_interest usi,
			interest_section ise,
			interest_category ic
		WHERE
			us.pn = usi.seller_pn
		AND
			usi.section_pn = ise.pn
		AND
			ise.category_pn = ic.pn
		AND
			ise.category_pn = #{categoryPn}
		GROUP BY 
			us.pn
		ORDER BY
			us.pn
		<include refid="paginationAfter"/>
	</select>
	
	<select id="selectFromInterestCount" parameterType="com.bg.jtown.business.search.HomeFilter" resultType="java.lang.Integer">
		SELECT
			COUNT(*)
		FROM
			user_seller us,
			user_seller_interest usi,
			interest_section ise,
			interest_category ic
		WHERE
			us.pn = usi.seller_pn
		AND
			usi.section_pn = ise.pn
		AND
			ise.category_pn = ic.pn
		AND
			ise.pn = #{sectionPn}
		ORDER BY
			us.pn
	</select>
	
	<select id="selectFromInterest" parameterType="com.bg.jtown.business.search.HomeFilter" resultMap="jtown-seller-map">
		<include refid="paginationBefore"/>
		SELECT
			us.pn, us.shop_name, us.shop_url, us.notice, 
			us.love_count, us.view_count
		FROM
			user_seller us,
			user_seller_interest usi,
			interest_section ise,
			interest_category ic
		WHERE
			us.pn = usi.seller_pn
		AND
			usi.section_pn = ise.pn
		AND
			ise.category_pn = ic.pn
		AND
			ise.pn = #{sectionPn}
		ORDER BY
			us.pn
		<include refid="paginationAfter"/>
	</select>
	
	<resultMap type="com.bg.jtown.business.Home" id="jtown-seller-image-map" >
		<result column="seller_pn" property="sellerPn" />
		<association property="" ></association>
		<collection property="saveNameList" column="save_name" javaType="java.util.ArrayList" ofType="java.lang.String" select=""/>
	</resultMap>
	
	<select id="selectSellerImage" resultMap="jtown-seller-image-map">
		SELECT
			seller_pn, save_name
		FROM
			user_seller_image_name
		WHERE
			seller_pn IN
			<foreach collection="list" item="item" index="index"  open="(" separator="," close=")">
				#{item.value}
			</foreach>
	</select>
</mapper>