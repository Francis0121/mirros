<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="AdminMapper">	
	<resultMap type="JtownUser" id="usersMap">
		<result column="pn" property="pn"/>
		<result column="id" property="username"/>
		<result column="enable" property="enabled"/>
		<result column="salt" property="salt" />
	</resultMap>
	
	<resultMap type="Interest" id="interestCategoryMap">
		<result property="categoryPn" column="category_pn" />
		<result property="name" column="name"/>
	</resultMap>
	
	<select id="getInterestCategoryList" resultMap="interestCategoryMap">
		SELECT
			pn AS category_pn, name
		FROM
			interest_category
	</select>
	
	<select id="interestSectionPn" parameterType="String" resultType="Integer">
		SELECT
			pn
		FROM
			interest_section
		WHERE
			name = #{interest}
	</select>
	
	<insert id="insertInterestSection" parameterType="Interest">
		INSERT INTO
			interest_section
			(
				category_pn, name
			)
		VALUES
			(
				#{categoryPn}, #{name}
			)
		<selectKey keyProperty="sectionPn" resultType="Integer">
			SELECT LAST_INSERT_ID()
		</selectKey>			
	</insert>
	
	<insert id="insertUserInterest" parameterType="Interest">
		INSERT INTO
			user_seller_interest
			(
				seller_pn, section_pn
			)
		VALUES
			(
				#{sellerPn}, #{sectionPn}
			)
	</insert>
	
	<resultMap type="Interest" id="getInterestNameListMap" extends="interestCategoryMap">
		<result column="customer_pn" property="customerPn"/>
		<result column="seller_pn" property="sellerPn"/>
		<result column="interest_name_list" property="interestSectionNameList" />
	</resultMap>
	
	<select id="getInterestNameList" parameterType="UserSearch" resultMap="getInterestNameListMap">
		SELECT 
			seller_pn, category_pn, interest_name_list
		FROM (
			SELECT
				*, GROUP_CONCAT(isn.name) AS interest_name_list
			FROM
				interest_section isn,
				user_seller_interest usi
			WHERE
				isn.pn = usi.section_pn
			GROUP BY usi.seller_pn
		) interest			
	</select>
	
	<resultMap type="JtownUser" id="getSellerListMap" extends="usersMap">
		<result column="shop_name" property="shopName"/>
		<result column="shop_url" property="shopUrl"/>
	</resultMap>
	
	<select id="getSellerList" parameterType="UserSearch" resultMap="getSellerListMap">
		SELECT
			u.pn, us.shop_name, us.shop_url, u.id, u.enable
		FROM
			(SELECT
				pn, id, ENABLE
			FROM
				users
			WHERE
				id LIKE	'seller%'
			) u, user_seller us
		WHERE
			u.pn = us.pn
	</select>
	
	<update id="updateShopUrl" parameterType="JtownUser">
		UPDATE
			user_seller
		SET
			shop_url = #{shopUrl}
		WHERE
			pn = #{pn}
	</update>
	
	<delete id="deleteInterestSellerInterest" parameterType="Interest">
		DELETE
		FROM
			user_seller_interest
		WHERE
			seller_pn = #{sellerPn}
	</delete>
	
	<update id="updateEnable" parameterType="JtownUser">
		UPDATE
			users
		SET
			enable = #{enabled}
		WHERE
			id = #{username}
	</update>
	
	<resultMap type="JtownUser" id="getCustomerListMap" extends="usersMap">
		<result column="name" property="name" />
		<result column="join_date" property="joinDate" />
	</resultMap>
	<select id="getCustomerList" parameterType="UserSearch" resultMap="getCustomerListMap">
		SELECT
			u.pn, u.id, uc.name, u.enable, uc.join_date
		FROM
			(SELECT
				pn, id, ENABLE
			FROM
				users
			WHERE
				id NOT LIKE 'seller%'
			AND
				id NOT LIKE 'admin%'
			) u, user_customer uc
		WHERE
			u.pn = uc.pn		
	</select>
	
	<select id="getCustomerInterestList" parameterType="UserSearch" resultMap="interestCategoryMap">
		SELECT 
			customer_pn, category_pn, interest_name_list
		FROM (
			SELECT
				*, GROUP_CONCAT(isn.name) AS interest_name_list
			FROM
				interest_section isn,
				user_customer_interest uci
			WHERE
				isn.pn = uci.section_pn
			GROUP BY uci.customer_pn
		) interest		
	</select>
</mapper>