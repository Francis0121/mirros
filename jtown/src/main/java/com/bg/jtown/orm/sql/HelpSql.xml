<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="helpMapper">

	<sql id="paginationBefore">
		SELECT 
			t.*
		FROM 
		( 
			SELECT  
				z.*, @RNUM := @RNUM + 1 AS rnum
			FROM
				(
	</sql>
	
	<sql id="paginationAfter">
		<![CDATA[
				) z,  
				( SELECT @RNUM := 0 ) R
			WHERE @RNUM + 1 <=  #{pagination.itemSeqEnd}
		) t
		WHERE t.rnum >= #{pagination.itemSeqBegin}
		]]>
	</sql>
	
	<!-- Partnership -->
	<resultMap type="com.bg.jtown.business.Partnership" id="jtown-help-partnership-map">
		<result column="pn" property="pn"/>
		<result column="name" property="name"/>
		<result column="email" property="email"/>
		<result column="phone_number" property="phoneNumber"/>
		<result column="category_pn" property="categoryPn"/>
		<result column="content" property="content"/>
		<result column="process" property="process"/>
		<result column="input_date" property="inputDate"/>
		<result column="update_date" property="updateDate"/>
		<result column="seller_pn" property="jtownUser.pn"/>
		<result column="shop_url" property="jtownUser.shopUrl"/>
		<result column="id" property="jtownUser.username"/>
		<result column="enable" property="jtownUser.enabled"/>
		<result column="salt" property="jtownUser.salt"/>
		<result column="seller_name" property="jtownUser.name"/>
		<result column="admin_pn" property="adminUser.pn"/>
		<result column="admin_name" property="adminUser.name"/>
	</resultMap>
	
	<select id="selectPartnershipList" parameterType="com.bg.jtown.business.search.PartnershipFilter" resultMap="jtown-help-partnership-map">
		<include refid="paginationBefore"/>
		SELECT
			p.pn, p.name, p.email, p.phone_number,
			p.category_pn, p.content, p.process, p.input_date, p.update_date,
			u.pn AS seller_pn, u.shop_url, u.id, u.enable, u.salt, u.name AS seller_name,
			ua.pn AS admin_pn, ua.name AS admin_name
		FROM
			partnership p
			LEFT OUTER JOIN ( SELECT us.pn, us.shop_url, u.id, u.enable, u.salt, u.name FROM user_seller us, users u WHERE us.pn = u.pn ) u
			ON u.pn = p.seller_pn
			LEFT OUTER JOIN ( SELECT u.pn, u.name FROM user_admin ua, users u WHERE ua.pn = u.pn AND u.enable = TRUE ) ua
			ON ua.pn = p.admin_pn
		WHERE
			1 = 1
		<if test="process != null">
		AND	
			process = #{process}	
		</if>
		<if test="categoryPn != null">
		AND
			category_pn = #{categoryPn}
		</if>
		<if test="searchEmail != null and searchEmail != ''">
		AND
			email LIKE #{searchEmail}
		</if>
		<if test="searchPhoneNumber != null and searchPhoneNumber != ''">
		AND
			phone_number LIKE #{searchPhoneNumber}
		</if>	
		ORDER BY
			p.pn DESC
		<include refid="paginationAfter"/>
	</select>
	
	<select id="selectPartnership" parameterType="java.lang.Integer" resultMap="jtown-help-partnership-map">
		SELECT
			p.pn, p.name, p.email, p.phone_number,
			p.category_pn, p.content, p.process, p.input_date, p.update_date
		FROM
			partnership p
		WHERE
		<if test="pn != null">
			pn = #{pn}		
		</if>
		<if test="email != null">
			email = #{email}
		AND
			process = 1
		</if>
		<if test="phoneNumber != null">
			phone_number = #{phoneNumber}
		AND
			process = 1
		</if>
	</select>
	
	<select id="selectPartnershipCount" parameterType="com.bg.jtown.business.search.PartnershipFilter" resultType="java.lang.Integer">
		SELECT
			COUNT(*)
		FROM
			partnership
		WHERE
			1 = 1
		<if test="process != null">
		AND	
			process = #{process}	
		</if>
		<if test="categoryPn != null">
		AND
			category_pn = #{categoryPn}
		</if>
		<if test="searchEmail != null and searchEmail != ''">
		AND
			email LIKE #{searchEmail}
		</if>
		<if test="searchPhoneNumber != null and searchPhoneNumber != ''">
		AND
			phone_number LIKE #{searchPhoneNumber}
		</if>		
	</select>
	
	<insert id="insertPartnership" parameterType="com.bg.jtown.business.Partnership">
		INSERT INTO
			partnership
			(	name,	email,	phone_number,	category_pn,	content,	process, input_date, update_date	)
		VAlUES	
			(	#{name},	#{email},	#{phoneNumber},	#{categoryPn},	#{content}, #{process}, SYSDATE(), SYSDATE()	)
		<selectKey keyProperty="pn" resultType="java.lang.Integer">
			SELECT LAST_INSERT_ID()
		</selectKey>
	</insert>
	
	<delete id="deletePartnership" parameterType="com.bg.jtown.business.Partnership">
		DELETE FROM
			partnership
		<if test="pn != null">
		WHERE
			pn = #{pn}
		</if>
	</delete>
	
	<update id="updatePatnership" parameterType="com.bg.jtown.business.Partnership">
		UPDATE
			partnership
		SET
			update_date = SYSDATE(),
			<if test="name != null and name !='' ">
				name = #{name}
			</if>
			<if	test="email != null and email !='' ">
				email = #{email}
			</if>
			<if test="phoneNumber != null and phoneNumber !='' ">
				phone_number = #{phoneNumber}
			</if>
			<if test="process != null and process !='' ">
				process = #{process}			
			</if>
			<if test="categoryPn != null and categoryPn != '' ">
				category_pn = #{categoryPn}
			</if>
		WHERE
			pn = #{pn}
	</update>
		
	<update id="updatePartnershipJsonA" parameterType="com.bg.jtown.business.Json">
		UPDATE
			partnership
		SET
			update_date = SYSDATE(),
			<choose>
				<when test="value == null || value == ''">
					admin_pn = null
				</when>
				<otherwise>
					admin_pn = #{value}
				</otherwise>
			</choose>
		WHERE
			pn = #{key}
	</update>
	
	<update id="updatePartnershipJsonS" parameterType="com.bg.jtown.business.Json">
		UPDATE
			partnership
		SET
			update_date = SYSDATE(),
			<choose>
				<when test="value == null || value == ''">
					seller_pn = null
				</when>
				<otherwise>
					seller_pn = #{value}
				</otherwise>
			</choose>
		WHERE
			pn = #{key}
	</update>
	
	<select id="selectAdminIdList" resultType="JtownUser">
		SELECT
			u.pn, u.name
		FROM
			user_admin ua,
			users u
		WHERE
			ua.pn = u.pn
		AND
			u.enable = TRUE
	</select>
	
</mapper>